<!DOCTYPE html>
<html>

<head>
    <meta content="text/html; charset=Shift_JIS" http-equiv="content-type">
    <title>LR2beta3 スキンcsv仕様書 応用編</title>
    <meta name="author" content=".RED">
    <meta name="GENERATOR" content="MSHTML 8.00.6001.23520">
    <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">
    <style type="text/css">
        body {
            font-size: 12px;
        }
        
        div {
            margin-left: 10px;
            padding-bottom: 30px;
        }
        
        p {
            margin-left: 20px;
        }
        
        h4 {
            margin-top: 4em;
            width: 96%;
            width: calc(100% - 14px);
            background: -moz-linear-gradient(white, #E0E0E0);
            background: -webkit-gradient(linear, left top, left bottom, from(white), to(#E0E0E0));
            background: -ms-linear-gradient(top, white, #E0E0E0);
            -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr='#cFFF', endColorstr='#E0E0E0', GradientType=0)";
            padding: 6px;
            border: solid 1px #999;
            border-radius: 3px;
        }
        
        h4:before {
            width: 5px;
            display: inline-block;
            background: #666;
            content: "　";
            margin-right: 5px;
            padding: 2px;
        }
    </style>
</head>

<body>
    <h2>その他 </h2>
    <div id="content">
        <a id="timing" name="timing">
            <h4>LR2スキンにおけるファイルの読み込みタイミングと動作タイミング</h4>
        </a>
        <p> LR2スキンでの画像ファイルの読み込みタイミングには2通りのパターンがあります。
            <br> OS依存でも本体バージョン依存でもないため、現状では&ldquo;PCによる&rdquo;としか言えませんが
            <br> スキン動作開始時か定義動作開始時のどちらかになります。ちょっと面倒なことにスキン依存ではありません。
            <br>
            <br> 後者の場合は特にプレイスキンだと曲開始後に参照するパーツが増えるので、
            <br> どっちでも問題なく動くようにサイズの大きい画像を使用する場合は念のため
            <a title="DX3+cb6" target="_blank" href="http://www.geocities.jp/cbrk803832/">DX3+cb6</a>のようにパーツの事前読み込みを入れておきましょう。
            <br> （プレイスキンで最初の1ノーツ目がカクつく場合はこれが原因です）
            <br>
            <br> つまりスキンをOA DX+ LINKに対応させるとそれなりにメモリを圧迫する場合がある、という事でもあります。
            <br> twitterでは「負荷変わらない」と豪語しましたが2通りあるって知ったの最近なんです。ごめんなさい。
        </p>
        <h4><a id="abend" name="abend"></a> スキン種別と落ちやすさ </h4>
        <p> 体感では「理由がさっぱり分からない異常終了」を除けば、異常終了耐性はバックグラウンド処理が少ないほど高いです。
            <br> 大体のスキンでは本体側が限界ギリギリな動作を行っているため、下手な操作を行ったり無茶なスキン構成にすると簡単に落ちますが
            <br> リザルト系のスキンは内部的にはプレイ結果の表示とLR2IRとの通信くらいしか行われないので、色々詰め込んでも意外と普通に動きます。
        </p>
        <a id="fps" name="fps">
            <h4>DST定義とfps</h4>
        </a>
        <p> おそらくXP環境限定のお話。
            <br> LR2スキンでは膨大な量のパーツを同時に表示すると出力fpsが落ちます。酷い時は半減くらいまでいきます。DX+のタイトルエフェクトTYPE-6が代表的。
            <br> （1.5秒間で1050個、その後1.5秒で1050個の画像が動きます）
        </p>
        <p>タイトルエフェクトは動作終了後にop分岐とloop=-1で動作を完全に停止させていますが、一度低下したfpsはそのスキンが動作している間は元には戻りません。
            <br> また、csvの行数的にはTYPE-3もほぼ同じ長さですがこちらはtime指定が複雑になっているだけで、定義数は350個となっており大幅なfps低下は発生しませんでした。
            <br> つまりcsvの行数とは無関係。
            <br> この結果から出力fpsは最大瞬間実動定義数に依存していることが分かります。
            <br>
            <br> 垂直同期を使用した際の挙動から出力fpsはLR2の最小キー入力インターバルであると考えられるため、
            <br> 出力fpsの低下=キー入力タイミングのブレ=スコアの低下に繋がります。プレイスキンは極力軽量化しましょう。
            <br> ※参考：
            <a href="http://stairway.sakura.ne.jp/bms/delay.htm">LR2遅延対策入門 - Stairway</a>の一番下の考察</p>
        <p>Win7は最大出力fpsこそXPに劣るもののXPと違ってfpsが安定しており、実動定義数が増えてもfpsの低下率がXPより遥かに少なく、
            <br> 加えてスキン動作中に低下したfpsもパーツの動作が終わったら元に戻ります。
            <br>
            <br> 理論上はモニタのリフレッシュレート以上のfpsが出ていれば見た目に影響は無いはずですが、
            <br> 負荷によって値が大きく変動するXPでは曲プレイ中に2600fpsくらい出ていてもノーツの落下がよくコマ落ちします。（2pssエンコ動画BGAだと特に顕著）
        </p>
        <p>経験上、単純に最大fpsが高いよりもfpsの変動が少ない方がノーツの落下アニメーションも安定するため、
            <br> スキンの挙動に関して言えばWin7の方がLR2向きだと考えています。
        </p>
        <a id="resolution" name="resolution">
            <h4>画像パーツ解像度と描画面積</h4>
        </a>
        <p> スキンの負荷は画像ファイルの実解像度に依存するものだと思ってましたが、実際には描画解像度と密接な関係にあるようです。
            <br> （同じ画像ファイルでもDST側でサイズを縮小すると負荷が減ります）
            <br> また、画面外にはみ出す部分は
            <u>描画が行われない</u>らしく、fpsの低下には直接絡んではきません。
            <br> ※上記の実動定義数の影響は多少受けます。
            <br>
            <br> ついでに、8192x8192の画像を読み込ませた際、RB選曲は普通に動いていたのに対してDX+は即死したので
            <br> 本体側の読み込み解像度限界がどこかにあると見ています。
            <br> フォント画像も関わっているはずなんで詳しくは調べていませんが、8192x8192を読み込ませてもRB選曲が落ちなかった事から
            <br> 2048x2048x16枚くらいは耐えられると思われます。
        </p>
        <a id="memory" name="memory">
            <h4>スキンパーツとメモリ負荷</h4>
        </a>
        <p> 詳しいことは分かりませんがプログラムである以上、
            <br> スキンで使う全画像ファイルの合計解像度が増えればメモリの消費量もきっと上がるでしょう。ついでにfpsも落ちます。
            <br>
            <br> デフォ選曲フォントには「サイズは256の倍数推奨」と書いてあるので、
            <br> スキン画像もある程度このフォーマットに乗っ取っていた方が安定するだろう、
            <br> と思ってたんですが実測fpsでは大差無かったのでうちのスキンはガン無視です。
            <br> 16の倍数になってりゃ良いんじゃね？とかその程度です。
            <br> （全画像サイズを揃えるとかだと違うのかもしれませんが）
            <br>
            <br> LR2に限らずPCゲームにおいては利用する画像のサイズは2のべき乗が望ましいと言われていますが、
            <br> これは読み込める画像ファイル解像度の最小単位が2のべき乗である事が関係しているそうで、
            <br> 例えば257ｘ257の画像を参照する際には内部的に512ｘ512を取ってしまうためとかそんなんらしいです。（詳しくは知りません）
        </p>
        <p>これに加えてtga/ddsといった&ldquo;テクスチャに使用するためのフォーマット&rdquo;を使うことでより軽量化できるのかもしれません。
            <br> LR2デフォスキンが異様に軽いのはこの辺が絡んでいると予想しています。
            <br>
            <br> また、うちのスキンでは汎用性を重視して画像ファイルはすべてpng形式の最高圧縮を使っていますが、
            <br> 無圧縮tgaをdxa圧縮した方が僅かに描写が早く、fpsも3%程上がりました。
            <br> （dxa圧縮すると無圧縮tgaでも色数によってはpng形式とほぼ同じサイズまで落とせます）
        </p>
        <p>SSD起動のようにファイルの読み込み速度が無視出来るほど速い環境であれば、
            <br> 描写速度はほぼGPU依存なので悪くはないんですが、修正時にいちいちdxa展開するのも考え物。
            <br> 基本的にはフォント画像でのみ使うのが無難かもしれません。
            <br> （選曲画面のフォルダ展開速度がほんのり速いかも？程度なので、むしろフォント以外で使う理由が無い）
        </p>
        <p>tgaとddsでの違いは全然分かりませんでしたが、VRAM使用量はバイト数単位でpng形式時と同じだったので、
            <br> 画像フォーマットを変えてもどのみちLR2の異常終了は防げないだろうと考えています。
            <br>
            <br> メモリリークはLR2本体側の不具合なのでメモリ増設しても回避出来るものではありませんが、
            <br> 気にし過ぎたらいつまで経っても公開出来ないのである程度は割り切っちゃった方が製作は楽です。
            <br> 落ちやすい操作さえ避ければそもそもそんなに落ちませんし、逆にどんな軽量スキン使ってても激重bms読み込んだら落ちます。 </p>
    </div>
</body>

</html>