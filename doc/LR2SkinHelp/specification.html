<!DOCTYPE html>
<html>

<head>
    <meta content="text/html; charset=Shift_JIS" http-equiv="content-type">
    <title>LR2beta3 スキンcsv仕様書 応用編</title>
    <meta name="author" content=".RED">
    <meta name="GENERATOR" content="MSHTML 8.00.6001.23520">
    <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">
    <style type="text/css">
        body {
            font-size: 12px;
        }
        
        div {
            margin-left: 10px;
            padding-bottom: 30px;
        }
        
        p {
            margin-left: 20px;
        }
        
        h4 {
            margin-top: 4em;
            width: 96%;
            width: calc(100% - 14px);
            background: -moz-linear-gradient(white, #E0E0E0);
            background: -webkit-gradient(linear, left top, left bottom, from(white), to(#E0E0E0));
            background: -ms-linear-gradient(top, white, #E0E0E0);
            -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr='#cFFF', endColorstr='#E0E0E0', GradientType=0)";
            padding: 6px;
            border: solid 1px #999;
            border-radius: 3px;
        }
        
        h4:before {
            width: 5px;
            display: inline-block;
            background: #666;
            content: "　";
            margin-right: 5px;
            padding: 2px;
        }
        
        .caution {
            padding-left: 1em;
            text-indent: -1em;
        }
    </style>
</head>

<body>
    <h2>仕様関連</h2>
    <div id="content">
        <a id="div" name="div">
            <h4>div_x・div_yパラメータ</h4>
        </a>
        <p> 大体はスキン見れば想像付くとは思いますが一応補足。
            <br> div_xとdiv_yによる分割アニメーションの並び順は横方向優先です。
            <br> 分かりやすくNUMBER定義で図にしてみましたが、NUMBER定義に限らずLR2では必ずこうなります。
        </p>
        <p>
            <a target="_blank" href="number_split.png"><img alt="number" src="number_split.png" border="0" height="298" width="264">
            </a>
        </p>
        <p>30分割はcycle値で指定された時間（単位：ms）で3色点滅する10分割NUMBER定義です。
            <br>
            <br> 24分割辺りだと約数が多いのでスペースを有効に使えますが、11分割は縦・横いずれかで
            <br> 1列に並べるしか方法が無いので、どんなに頑張ってもそこそこのサイズになります。
            <br> なお、NUMBER定義は10or11or24のいずれかの整数倍、BUTTON定義は各ボタンタイプ毎の分割数厳守。
            <br> 多かったり足りなかったりすると正常に動作しません。
        </p>
        <p>ちなみにボタン定義はNUMBER定義のように規定数の整数倍に分割してもアニメーション出来ないので、
            <br> アニメーションさせるには複数のボタン定義をtimeでガッチリ区切って無理矢理表示を切り替えるしかありません。
            <br> （ClassicスキンのLR2files/Theme/Classic/FX/FX-TYPE-1/TYPE-1.csv参照）
            <br>
            <br> また、ボタンtype11 現在の鍵盤数フィルタ(全体) 等は使用している難易度フィルタや鍵盤数フィルタで
            <br> 実際に動作するボタン数が変わってくるので動作確認時には注意が必要です。
            <br>
            <br> ついでに3色点滅についても触れておきますが、
            <br> 赤青緑の3色点滅パーツは白を混ぜ込んで気持ち明るめにしておいた方が目に優しいです。
        </p>
        <p>
            <a href="light.gif" target="_blank"><img src="light.gif" alt="light" border="0" height="12" width="86">
            </a>
        </p>
        <a id="pitch" name="pitch">
            <h4>エフェクタボタンのピッチ</h4>
        </a>
        <p> ボタンの分割数絡みで一点だけ注意事項。
            <br> type20からのFX名はbutton.txtではピッチを含めた9種類が書かれていますが、
            <br> 現行のLR2ではピッチはここには含まれません。別枠でtype32と33に分離されています。
        </p>
        <p class="caution">※ただし9分割でもピッチを飛ばしてオフに戻るので特に問題はありません。</p>
        <a id="lr2font" name="lr2font">
            <h4>スキンで参照可能なフォント数</h4>
        </a>
        <p> 1つのスキンで参照できるLR2フォントの数は10個までです。環境によっては11個以上定義したスキンを使うと即落ちするらしいので注意。
            <br> フォント定義が10個越えることはあまり無いとは思いますが分岐ミスでの重複読み込みなどには気を付けましょう。
        </p>
        <a id="lr2fontfile" name="lr2fontfile">
            <h4>LR2フォント調整時の注意</h4>
        </a>
        <p> lr2fontファイルはスキンcsvや画像・動画等と扱いが異なるようで、LR2起動中に変更しても適用されません。
            <br> （スキンを一瞬でも読み込ませるとlr2fontファイルがLR2body.exeにロックされます）
            <br> このためスキンオプションで切り替える場合でもLR2の再起動が必要です。
            <br>
        </p>
        <p class="caution">※上述のフォント10個の制限とプロセスロックの仕様により、LR2フォントを10個使い切っているスキンでのオプションによるフォント切り替えは
            <br> 瞬間的に読み込みフォント数が11個になるため切り替えた瞬間にLR2が落ちます。
        </p>
        <p class="caution">※lr2fontファイルから参照される画像ファイルはロックされませんが、
            <br> dxa圧縮している場合はパッケージごとロックされるためLR2起動中は展開出来なくなります。
        </p>
        <p> スキンの頻繁な変更でLR2が落ちやすくなるのはこれのせい、というのが.REDの私見です。
            <br> 誤って別なスキンを読み込まない様にThemeフォルダの中は常用するスキン以外置かない、というのが
            <br> 異常終了回避の有効な方法の1つだと思います。
        </p>
        <a id="filter" name="filter">
            <h4>拡大縮小とfilter値</h4>
        </a>
        <p> 主にエフェクト系の話ですが、徐々に拡大（縮小）する透過（あるいは加算）パーツにfilterを使ってしまうと
            <br> アニメーション中にSRCの指定範囲外のピクセルが見えてしまう事があります。
        </p>
        <p>
            <a href="noize.png" target="_blank"><img src="noize.png" alt="noize" border="0" height="240" width="320">
            </a>
        </p>
        <p>このため拡縮パーツをぼかしたい場合はSRC画像側で他の画像パーツと隣接させない等の工夫が必要です。
            <br> また、ぼかし固定の場合であれば体側のfilterではなく、SRC画像側をあらかじめぼかすという手もあります。
            <br> （LR2のfilterは基本的にはBGA用です。また、仕様書によると処理が重いらしいので多用は避けましょう）
        </p>
        <p class="caution">※画質を追求すると最終的には可逆圧縮動画かdivアニメーションになります。</p>
        <a id="gauge_option" name="gauge_option">
            <h4>ゲージ色に関わるオプションと分岐</h4>
        </a>
        <p> IFとスロットで特性が異なる、つまりスキン動作開始直後としばらく経った後で値が変わるオプション値では良く起こる現象ですが、
            <br> ゲージ色に関わるオプション値（op42〜45、op63〜66）では『現在のゲージオプション』と『リプレイに保存されているゲージオプション』が異なる場合、
            <br> そのリプレイを再生するとIF分岐（スキン動作開始直後）は現在のゲージオプション準拠、次の瞬間にスロット分岐がリプレイ準拠のゲージに切り替わり、以降は変動しなくなります。
        </p>
        <p>
            上述の通り、スロット分岐のみでの実装には制約が大きいため応用範囲は多少狭まりますが、ゲージの色で分岐させたいシーンは往々にして起こり得るものです。
            <br> 実装時には注意しましょう。
        </p>
        <a id="or_and_not" name="or_and_not">
            <h4>IF命令とSETOPTION命令を使ったOR分岐とNOT分岐</h4>
        </a>
        <p> どちらも99個しか使えないスキン固有のDSTオプションのうち1個を使うので必須かと言うとやや微妙。
            <br> ただ、条件が2個程度であれば分岐させる必要はありませんが、これが10個20個になると作った方が確実です。
            <br>
        </p>
        <ul>
            <li> OR分岐
                <br> 条件Aと条件BのどちらかがONならop900がON
            </li>
            <p> #IF,条件A
                <br> #SETOPTION,900,1
                <br> #ENDIF
                <br>
                <br> #IF,条件B
                <br> #SETOPTION,900,1
                <br> #ENDIF
                <br>
            </p>
        </ul>
        <ul>
            <li>NOT分岐
                <br> 条件A以外ならop900がON
                <br>
                <p> #IF,条件A
                    <br> #ELSE
                    <br> #SETOPTION,900,1
                    <br> #ENDIF
                    <br>
                </p>
            </li>
        </ul>
        <p> NOT分岐は特にDSTオプションでONのみしか用意されていなくて、
            <br> かつIFで複数定義をごっそり分岐させたい時にあると便利です。
        </p>
        <a id="setoption" name="setoption">
            <h4>SETOPTION命令の特性</h4>
        </a>
        <p> SETOPTION定義は特定のDST値をONにするだけでなく、OFFにすることも可能ですが
            <br> 同一csv内でONとOFFを宣言した場合は後に記述した方が適用されます。（ちなみにFLIPRESULT命令なども同様）
            <br> また、当然と言えば当然ですがSETOPTIONでON/OFFを制御できるのは900番台のオプションだけです。
            <br>
            <br> ただし、通常オプションも全てSETOPTIONで900番台にリンクさせてからスキンを組んでいけば
            <br> 通常オプション用の機能も強制的にONに出来るようになります。
        </p>
        <a id="double_button" name="double_button">
            <h4>ボタン定義の重ね順</h4>
        </a>
        <p> ボタン定義を複数個重ねた場合、マウスでクリックするとcsv内で先に記述したボタンから順に押されます。
            <br> 重ねたボタンがクリック不可設定であれば先に記述されているボタンもクリック出来なくなるので誤クリック防止に使えますが、
            <br> この時利用できるのはそのシーンで動作可能なボタンに限られます。
        </p>
        <p>複合ボタン定義はRED BLET KEYCONFIGで使われています。
            <br> 詳しくはRED_BELT/KeyConfig/keyconfig.csv内を「//TEST PLAY PANELボタン本体」で検索して下さい。
            <br>
        </p>
        <p class="caution">※テストプレイボタン動作詳細
            <br> テストプレイモードに入る際には必ずキーコンフィグ選択を「OFF」にしておかないと
            <br> テストプレイでボタンを押した時に片っ端から割り当てられてしまいますが、
            <br> ワンクリックで「OFF」に持っていく方法が無いので1P1鍵&rarr;鍵盤変更ボタンplusonly=2（逆順）の順番でボタンを重ね、
            <br> 更にその上にテストプレイパネル起動ボタンを重ねてます。
        </p>
        <a id="sound" name="sound">
            <h4>サウンドセット以外の音声参照</h4>
        </a>
        <p> 音声トラック付きの動画を読み込ませれば音出るかと思って試しましたが無理でした。
            <br> この事からLR2で参照される動画データの音声部分は再生されないという事も分かります。（BGAも同様です）
        </p>
        <a id="course" name="course">
            <h4>コースモードでは使えない機能</h4>
        </a>
        <p> コースモードではSTAGEFILEやBACKBMP等のbms側で用意されている画像や、判定ランクやソフラン有無などの譜面データが参照出来ません。（BGAは可）
            <br> 参照出来るのはせいぜい難易度種別（NORMAL/HYPERなど）ぐらいですがこれもコースステージ毎にキッチリ分岐させないと何故か正常に表示されません。
        </p>
        <p class="caution">※動作オプション解析によりDX3やDX+ほど長々と分岐させなくても動くっぽいことが判明してます。</p>
        <a id="dynamic_option" name="dynamic_option">
            <h4>特定条件下でのみ参照値が異なる機能</h4>
        </a>
        <p>LR2ではいくつかの値が複数値兼用になっており、条件によって本来の参照値ではないものが表示される場合があります。
            <br> イメージとしてはクリック不可なボタン定義の様なものですが、当然ボタン定義の話ではありません。
        </p>
        <ul>
            <li>st20 現在の曲のタイトル
                <br> →オンライン時timer152を使うSRC_TEXT定義のみIRメッセージ
                <br> （timer152 リザルトハイスコア更新タイマーを使うので実質リザルトスキン限定）
            </li>
            <br>
            <li>num100〜158 及び170番台
                <br> →コースリザルトではコース全体の数値
            </li>
            <br>
            <li>graph20以降？
                <br> →コースリザルトではコース全体の数値（30番台は未確認）
            </li>
        </ul>
        <a id="flip" name="flip">
            <h4>DP FLIPとSP TO DP</h4>
        </a>
        <p> 仕様か不具合かでちょっと迷いましたが仕様に分類しておきます。
            <br> DP FLIPオプションはRANDOM/MIRROR等と同じように本体側で制御されている機能であり、プレイスキン側で専用の定義を作る必要はありません。
            <br> で、先日初めて聞いたんですがSP TO DPオプション使用時はDP FLIPが使えません。
            <br> おそらくSP TO DPも本体側で制御されている機能だからだと思われます。</p>
        <a id="skin_option" name="skin_option">
            <h4>カスタマイズオプションの保存先</h4>
        </a>
        <p>LR2のスキンオプションの設定はLR2files\SkinCustomizeフォルダにxml形式で保存されます。
            <br> このxmlにはスキンカスタマイズの他に、数字キーで呼び出して設定する画面オプションも含まれます。
        </p>
        <p>スキンタイトルや作者名を書き換えても設定は引き継がれる事から、
            <br> カスタマイズ項目を元に生成されたハッシュ？でスキンを識別してる物と考えられます。（詳しく知りません）
        </p>
        <p>#CUSTOMOPTIONではオプション値しか保存されませんが#CUSTOMFILEでは選択した項目名が記録されるため、
            <br> 適当な目立つ名前のファイル/フォルダを選択状態でLR2を終了し、
            <br> SkinCustomizeフォルダ内のxmlに全文検索を掛ければそのスキンの設定ファイルが割り出せます。
            <br> あまり意味ありませんが。
        </p>
        <a id="skinselect" name="skinselect">
            <h4>スキンセレクト画面の特性</h4>
        </a>
        <p>どちらかと言うと豆知識的な内容になりますが、LR2のスキンセレクトスキンにはいくつか独特の仕様が存在します。
            <br>知っておくと意外と便利なものをいくつか紹介します。（スキンプレビューを使用している前提です）</p>
        <p><span style="font-weight: bold;">■オプション値の引き継ぎ</span>
            <br>詳しくは応用の方にまとめていますが、LR2は事前に動作していたスキンのDSTオプション値の大部分を引き継いで次のスキンが動作します。
            <br>スキンセレクトも同様に直前のスキン（ほぼ選曲スキンのみですが）でのオプション状態が、そのままスキンセレクト、つまりスキンプレビューに反映されます。</p>
        <p>例えば、コースリザルトにおける段位認定時の分岐動作を確認したい場合、段位認定にカーソルが合っている（op293 段位認定がON）状態で、
            <br>そのままスキンセレクト画面に入り、コースリザルトを選択すれば『段位認定時のスキンプレビュー』を見ることが出来ます。</p>
        <p><span style="font-weight: bold;">■クリア判定はスキンセレクト内で</span>
            <br>スキンセレクト画面に移動すると例外無く7keysプレイスキンのプレビュー動作が開始されます。
            <br>この時、曲進行バーが完全に停止する（＝プレイスキンが動作終了する）まで待つと、op90 リザ クリア がONになります。
            <br>逆に動作停止を待たずに他のスキン種別に切り替えてしまうとその時点で 91 リザ ミス がONになります。</p>
        <p>上手く使いこなせば曲クリアリザルトもクリア失敗リザルトもスキンプレビューで動作確認することが出来ます。
            <br>上の例で言えば、段位認定時の合格・不合格の動作確認も簡単に出来るので覚えておきましょう。
        </p>
        <p>なお、op90 or op91のクリア判定はスキンセレクト動作開始時の最初のプレビューで決まります。
            <br>このため、クリア判定オプションを切り替えたい場合は一度選曲スキンに戻る必要があります。
        </p>
        <p>関連リンク：<a href="application.html#option_change">LR2でのDSTオプション遷移</a></p>
        <a id="dark" name="dark">
            <h4>スキン描画制限の仕様</h4>
        </a>
        <p>LR2プレイスキンには数字の『5』キーを押しながらカーソルキー上下で設定できる『スキン描画制限』という本体側の機能があります。（通称DARKモード）
            <br>本来は低スペック環境で動作負荷を下げるために特定の定義の描画を制限してfpsを引き上げる機能ですが、昨今ではノーツが見やすいという理由で常用する人も少なくありません。
        </p>
        <p>DARKモードにはDARK1とDARK2の2段階が用意されており、DARK2ではほとんどの定義が非表示になります。
            <br>各モードで消える定義は以下の通り。なお、いずれのモードでもボムタイマー（timer50〜89）を使っている定義は種別に関わらず表示されます。
        </p>
        <ul>
            <li>DARK1：DST_IMAGE定義</li>
            <li>DARK2：DST_NOWJUDGE・DST_NOWCOMBO・DST_LINE・DST_NOTE・DST_GROOVEGAUGE以外</li>
        </ul>
        <a id="time-1" name="time-1">
            <h4>タイマー動作開始前の定義</h4>
        </a>
        <p>※803832さんのtwitterより
        </p>
        <p>DST定義のtime値を-1にするとその定義のtimerが動作開始する前の状態を定義することが出来ます。
            <br>この時loop値-1にしてもループ表示させることは出来ず、表示は消えるとの事です。なお、使い道はあまり無い模様。
        </p>
        <p>この情報はtwitter上でスキン屋勢が『スキンプレビューでのみ表示されないパーツ』の扱いについて議論していた際に出て来たもので、
            <br>スキンプレビューで非対応のタイマーを定義している場合、すなわち動作開始前のタイマーをトリガーとしてパーツを表示するために使われましたが、
            <br>今のところそれ以外の応用方法は見つかっていません。
        </p>
    </div>
</body>

</html>